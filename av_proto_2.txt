<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        main {
            height: 100vh;
            background-color: darkcyan;
            position: relative;
        }

        section {
            width: 200px;
            height: 200px;
            position: absolute;
            transition: all .1s ease;
            transform: translate(-50%, -50%);
            top: 50%;
            left: 50%;
            /* display: none; */
        }

        section .bar_container {
            position: absolute;
            bottom: 50%;
            left: 0;
            width: 100%;
            transform-origin: bottom center;
            display: flex;
            /* justify-content: space-between; */
            align-items: flex-end;
        }

        section .bar_container._1 {
            transform: translateY(-100px);
        }

        section .bar_container._2 {
            transform: rotateZ(90deg) translateY(-100px);
        }

        section .bar_container._3 {
            transform: rotateZ(180deg) translateY(-100px);
        }

        section .bar_container._4 {
            transform: rotateZ(270deg) translateY(-100px);
        }

        section .bar_container .bar {
            width: 3px;
            height: 1px;
            background-color: white;
            margin-right: 1px;
        }

        section .bar_container .bar:last-child {
            margin: 0;
        }
    </style>
</head>

<body>
    <main>
        <button onclick="play()">play</button>
        <section>
            <div class="bar_container _1"></div>
            <div class="bar_container _2"></div>
            <div class="bar_container _3"></div>
            <div class="bar_container _4"></div>
        </section>
    </main>

    <audio src="public/in_the_mood.mp3" id="audio_for_visual"></audio>
    <audio src="public/in_the_mood.mp3" id="audio_for_sound"></audio>

    <script>
        const av = document.querySelector("#audio_for_visual");
        const as = document.querySelector("#audio_for_sound");
        const wrapper = document.querySelector("section");
        const barContainers = document.querySelectorAll(".bar_container");
        const num_of_bars = 50;
        let allDiv = "";
        for (let i = 0; i < num_of_bars; i++) {
            allDiv += `<div class="bar _${i}"></div>`;
        }
        barContainers.forEach(bc => {
            bc.innerHTML = allDiv;
        })

        const play = _ => {
            const ctx = new AudioContext();
            const audioSource = ctx.createMediaElementSource(av);
            const analyzer = ctx.createAnalyser();
            audioSource.connect(analyzer);
            analyzer.connect(ctx.destination);
            analyzer.fftSize = 128;
            const frequencyData = new Uint8Array(analyzer.frequencyBinCount);
            analyzer.getByteFrequencyData(frequencyData);
            console.log("frequencyData", frequencyData);

            const renderFrame = _ => {
                analyzer.getByteFrequencyData(frequencyData);
                for (let i = 0; i <= num_of_bars; i++) {
                    const fd = frequencyData[i];
                    const bars = document.querySelectorAll(".bar._" + i);
                    if (!bars) continue;
                    const barHeight = Math.max(1, fd * 0.3 || 0);
                    bars.forEach(b => { b.style.height = barHeight + "px" });
                }
                wrapper.style.transform = `translate(-50%, -50%) scale(${Math.min(1.5, Math.max(1, frequencyData[1] * 0.006))})`;
                window.requestAnimationFrame(renderFrame);
            }
            renderFrame();
            av.volume = 0.1;
            av.play();
            as.play();
        }
    </script>
</body>

</html>